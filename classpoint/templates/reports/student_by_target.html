{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% block header_content %}
  Reporte por objetivo
{% endblock header_content %}

{% block page_title %}
  Reporte por objetivo
{% endblock page_title %}

{% block extra_css %}
  <style>
    #chart_div {
      width: 50%;
      min-width: 300px;
    }

    #student_evolution_div {
      width: 50%;
      min-width: 300px;
    }

    .row {
      margin: 0 !important;
    }

    .table-responsive {
      display: table;
    }
  </style>
{% endblock extra_css %}

{% block main_box_content %}
  <div class="row">
    <div class="col-lg-12">
      <div class="main-box clearfix">
        <header class="main-box-header clearfix">
          <h2></h2>
        </header>

        <div class="main-box-body clearfix">
          <p>
            <strong>
              <a class="btn btn-lg btn-primary" href="#student-list-header">Ir a listado de alumnos</a>
            </strong>
          </p>

          <form enctype="multipart/form-data" class="form-horizontal" method="get">
            {{ form|crispy }}
          </form>

          {% block charts %}
            {% if student %}
              <div class="row">
                <div id="chart_div"></div>
                <div id="student_evolution_div"></div>
              </div>
            {% endif %}
          {% endblock charts %}

          <h1 id="student-list-header">Listado de alumnos</h1>

          <div class="row">
            <div class="col-12">
              <table style="height: 100%" class="table table-responsive table-striped">
                <thead>
                <tr>
                  <th>Número de lista</th>
                  <th>Apellidos</th>
                  <th></th>
                  <th>Nombre</th>
                  <th></th>
                </tr>
                </thead>
                <tbody>
                {% for current_student in students %}
                  <tr {% if current_student == student %}class="text-success"{% endif %}>
                    <td>
                      {% if current_student != student %}
                        <a href="?student_id={{ current_student.pk }}">
                          {{ current_student.list_number }}
                        </a>
                      {% else %}
                        <strong>{{ current_student.list_number }}</strong>
                      {% endif %}
                    </td>
                    <td colspan="2">
                      {% if current_student != student %}
                        <a href="?student_id={{ current_student.pk }}">
                          {{ current_student.last_name }}
                        </a>
                      {% else %}
                        <strong>{{ current_student.last_name }}</strong>
                      {% endif %}
                    </td>
                    <td colspan="2">
                      {% if current_student != student %}
                        <a href="?student_id={{ current_student.pk }}">
                          {{ current_student.first_name }}
                        </a>
                      {% else %}
                        <strong>{{ current_student.first_name }}</strong>
                      {% endif %}
                    </td>
                    <td>
                      {% if current_student != student %}
                        <a class="btn btn-success"
                          style="width: 8.3vw;"
                           href="?{% if request.GET.core and request.GET.level and request.GET.group %}core={{ request.GET.core }}&level={{ request.GET.level }}&group={{ request.GET.group }}&learning_target={{ request.GET.learning_target }}&{% endif %}student_id={{ current_student.pk }}">
                          <i class="fa fa-check"></i>&nbsp;Ver desempeño
                        </a>
                      {% elif report == 'report_by_objective' %}
                        <a class="btn btn-warning"
                           style="width: 8.3vw;"
                           href="download-pdf/?student_id={{current_student.pk}}&level={{ form.level.value }}&core={{ form.core.value }}&group={{ form.group.value }}&school={{ form.school.value }}&learning_target={{ form.learning_target.value }}&bar_chart=[('{{ student.full_name }}', {{student_by_core_data.0.student_average}}), ('Curso {{ student.group.name }}', {{student_by_core_data.0.course_average}})]&line_chart={{student_evaluations}}">
                          <i class="fa fa-print"></i>&nbsp;Imprimir PDF
                        </a>
                      {% elif report == 'report_by_core' %}
                        <a class="btn btn-warning"
                            style="width: 8.3vw;"
                            href="download-pdf/?student_id={{current_student.pk}}&level={{ form.level.value }}&core={{ form.core.value }}&school={{ form.school.value }}&bar_chart=[('Nivel 3', {{ student_entry.achieved }}), ('Nivel 2', {{ student_entry.moderately_accomplished }}), ('Nivel 1', {{ student_entry.not_achieved }})]">
                          <i class="fa fa-print"></i>&nbsp;Imprimir PDF
                        </a>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5">No se encontraron alumnos</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock main_box_content %}



{% block content %}
{{current_student.pk}}

{% endblock content %}

{% block extra_js %}
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    {% if student %}
      google.charts.load(
        'current',
        {
          packages: [
            'corechart',
            'bar'
          ]
        }
      ).then(function () {
        var data = new google.visualization.DataTable();

        data.addColumn('string', 'Actividad');
        data.addColumn('number', 'Escala');
        data.addColumn({type: 'string', role: 'annotation'});
        data.addColumn({type: 'string', role: 'style'});

        data.addRows([
          {% for student_by_core_entry in student_by_core_data %}
            [
              '{{ student.full_name }}',
              {{ student_by_core_entry.student_average }},
              '{{ student_by_core_entry.student_average }}',
              'rgb(70, 136, 241)'
            ],
            [
              'Curso {{ student.group.name }}',
              {{ student_by_core_entry.course_average }},
              '{{ student_by_core_entry.course_average }}',
              'rgb(217, 69, 61)'
            ]{% if not forloop.last %},{% endif %}
          {% endfor %}
        ]);

        var options = {
          title: '{{ learning_target_pretty_name }}',
          legend: {
            position: 'none',
            alignment: 'start'
          },
          axes: {
            y: {
              Actividad: {label: 'Calificación'}
            }
          },
          hAxis: {
            title: 'Actividad'
          },
          vAxis: {
            title: 'Desempeño',
            minValue: 0,
            maxValue: 7
          },
        };

        var columnChartElement = document.getElementById('chart_div');
        var columnChart = new google.visualization.ColumnChart(columnChartElement);
        columnChart.draw(data, options);

        var studentEvolutionData = google.visualization.arrayToDataTable([
          ['Fecha', '{{ student.full_name }}', 'Curso'],
          {% if student_evaluations %}
            {% for date, evaluation, group_evaluation in student_evaluations %}
            ['{{ date }}', {{evaluation}}, {{ group_evaluation }}]{% if not forloop.last %},{% endif %}
            {% endfor %}
          {% else %}
            ['', 0, 0]
          {% endif %}
        ]);

        var studentEvolutionOptions = {
          title : '{{ learning_target_pretty_name }}',
          legend: {
            position: 'none',
            alignment: 'start'
          },
          vAxis: {
            title: 'Escala de apreciación',
            minValue: 0,
            maxValue: 7
          },
          hAxis: {
            title: 'Fecha de evaluación'
          },
          seriesType: 'lines'
        };

        chart = new google.visualization.ComboChart(document.getElementById('student_evolution_div'));
        chart.draw(studentEvolutionData, studentEvolutionOptions);
      });
    {% endif %}

    $(document).ready(
      function () {
        $('select#id_level').change(
          function () {
            $('#id_group,#id_learning_target').val('');
            $('form').submit();
          }
        );

        $("select#id_school").change(
          function(){
            $("select#id_group").val("");
            $('form').submit();
          }
        );

        $('select#id_core,select#id_group,select#id_learning_target').change(
          function () {
            $('form').submit();
          }
        )
      }
    );
  </script>
{% endblock extra_js %}
